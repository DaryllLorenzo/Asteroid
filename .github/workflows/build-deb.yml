name: Build .deb Package (Artifact Only)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Install application dependencies
        run: uv sync --frozen

      - name: Install fpm and system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev gcc make rpm dpkg-dev
          sudo gem install fpm

      - name: Prepare directory structure for .deb
        run: |
          mkdir -p pkg/opt/asteroid
          mkdir -p pkg/usr/bin
          mkdir -p pkg/usr/share/applications
          mkdir -p pkg/usr/share/icons/hicolor/256x256/apps

          cp -r app images main.py pyproject.toml uv.lock pkg/opt/asteroid/
          cp images/AsteroidLogo.png pkg/usr/share/icons/hicolor/256x256/apps/asteroid.png

          printf '%s\n' '#!/bin/sh' 'cd /opt/asteroid' 'exec python3 main.py "$@"' > pkg/usr/bin/asteroid
          chmod +x pkg/usr/bin/asteroid

          printf '%s\n' \
            '[Desktop Entry]' \
            'Name=Asteroid' \
            'Comment=Tropos/i* Modeling Tool' \
            'Exec=asteroid' \
            'Icon=asteroid' \
            'Terminal=false' \
            'Type=Application' \
            'Categories=Graphics;Education;' \
            'StartupWMClass=asteroid' \
            > pkg/usr/share/applications/asteroid.desktop
          chmod +x pkg/usr/share/applications/asteroid.desktop

      - name: Build .deb package
        run: |
          fpm -s dir -t deb \
              -n asteroid \
              -v 0.1.0 \
              --description "Asteroid: A Tropos/i* modeling tool built with PyQt6" \
              --maintainer "daryllla77@gmail.com" \
              --url "https://github.com/DaryllLorenzo/asteroid" \
              --license "MIT" \
              --depends python3 \
              --depends python3-pyqt6 \
              --architecture amd64 \
              -C pkg \
              .

      - name: Upload .deb as artifact
        uses: actions/upload-artifact@v4
        with:
          name: asteroid-deb-${{ github.sha }}
          path: asteroid_0.1.0_amd64.deb