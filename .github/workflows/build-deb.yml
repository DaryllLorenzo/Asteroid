name: Build .deb Package and Publish APT Repository

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        run: pip install uv

      - name: Install application dependencies
        run: uv sync --frozen

      - name: Install fpm and system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-dev gcc make rpm dpkg-dev
          sudo gem install fpm

      - name: Prepare directory structure for .deb
        run: |
          mkdir -p pkg/opt/asteroid
          mkdir -p pkg/usr/bin
          mkdir -p pkg/usr/share/applications
          mkdir -p pkg/usr/share/icons/hicolor/256x256/apps

          cp -r app images main.py pyproject.toml uv.lock pkg/opt/asteroid/
          cp images/AsteroidLogo.png pkg/usr/share/icons/hicolor/256x256/apps/asteroid.png

          printf '%s\n' '#!/bin/sh' 'cd /opt/asteroid' 'exec python3 main.py "$@"' > pkg/usr/bin/asteroid
          chmod +x pkg/usr/bin/asteroid

          printf '%s\n' \
            '[Desktop Entry]' \
            'Name=Asteroid' \
            'Comment=Tropos/i* Modeling Tool' \
            'Exec=asteroid' \
            'Icon=asteroid' \
            'Terminal=false' \
            'Type=Application' \
            'Categories=Graphics;Education;' \
            'StartupWMClass=asteroid' \
            > pkg/usr/share/applications/asteroid.desktop
          chmod +x pkg/usr/share/applications/asteroid.desktop

      - name: Build .deb package
        run: |
          fpm -s dir -t deb \
              -n asteroid \
              -v 0.1.0 \
              --description "Asteroid: A Tropos/i* modeling tool built with PyQt6" \
              --maintainer "daryllla77@gmail.com" \
              --url "https://github.com/DaryllLorenzo/asteroid" \
              --license "MIT" \
              --depends python3 \
              --depends python3-pyqt6 \
              --architecture amd64 \
              -C pkg \
              .

      - name: Set up APT repository structure
        run: |
          mkdir -p gh-pages/debian/pool/main/a/asteroid
          mkdir -p gh-pages/debian/dists/stable/main/binary-amd64

          cp asteroid_0.1.0_amd64.deb gh-pages/debian/pool/main/a/asteroid/

          pushd gh-pages/debian
          dpkg-scanpackages --multiversion pool/main > dists/stable/main/binary-amd64/Packages
          gzip -c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz

          printf '%s\n' \
            "Origin: Asteroid" \
            "Label: Asteroid APT Repository" \
            "Suite: stable" \
            "Codename: stable" \
            "Architectures: amd64" \
            "Components: main" \
            "Description: Custom APT repo for Asteroid" \
            "Date: $(date -Ru)" \
            > dists/stable/Release
          popd

      - name: Create minimal index.html
        run: |
          cat > gh-pages/index.html <<'EOF'
<!DOCTYPE html>
<html>
<head><title>Asteroid APT Repository</title></head>
<body>
<h1>Asteroid APT Repository</h1>
<p>Add to your system:</p>
<pre>
echo "deb [trusted=yes] https://darylllorenzo.github.io/asteroid/debian stable main" | sudo tee /etc/apt/sources.list.d/asteroid.list
sudo apt update && sudo apt install asteroid
</pre>
<p><a href="debian/">Browse packages</a></p>
</body>
</html>
EOF

      - name: Deploy APT repo to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          keep_files: false